namespace RailwayOrientedProgramming.Tests.Results.Extensions;

using FunctionalDdd.Testing;
using System.Diagnostics;

/// <summary>
/// Functional tests for ParallelAsync operations generated by ParallelAsyncs.g.tt.
/// Tests tuple construction and integration with AwaitAsync for parallel execution.
/// 
/// Note: ParallelAsync does NOT have tracing because it only constructs tuples without
/// evaluating results. Tracing happens in AwaitAsync where tasks are actually awaited
/// and results are combined.
/// 
/// Since all tuple sizes (3-9) are generated from the same T4 template, we test the
/// 3-tuple permutation comprehensively and validate other sizes work correctly.
/// </summary>
public class ParallelAsyncTests : TestBase
{
    #region 3-Tuple ParallelAsync Tests (Comprehensive Coverage)

    [Fact]
    public async Task ParallelAsync_3Tuple_AllSuccess_ReturnsCombinedTuple()
    {
        // Arrange
        var task1 = CreateDelayedSuccessTask(1, 10);
        var task2 = CreateDelayedSuccessTask(2, 20);
        var task3 = CreateDelayedSuccessTask(3, 15);

        // Act
        var result = await task1
            .ParallelAsync(task2)
            .ParallelAsync(task3)
            .AwaitAsync();

        // Assert
        result.Should().BeSuccess();
        result.Value.Should().Be((1, 2, 3));
    }

    [Fact]
    public async Task ParallelAsync_3Tuple_FirstFails_ReturnsFailure()
    {
        // Arrange
        var task1 = CreateDelayedFailureTask<int>(Error.Validation("First failed"), 10);
        var task2 = CreateDelayedSuccessTask(2, 20);
        var task3 = CreateDelayedSuccessTask(3, 15);

        // Act
        var result = await task1
            .ParallelAsync(task2)
            .ParallelAsync(task3)
            .AwaitAsync();

        // Assert
        result.Should().BeFailure();
        result.Error.Should().BeOfType<ValidationError>()
            .Which.Detail.Should().Be("First failed");
    }

    [Fact]
    public async Task ParallelAsync_3Tuple_SecondFails_ReturnsFailure()
    {
        // Arrange
        var task1 = CreateDelayedSuccessTask(1, 10);
        var task2 = CreateDelayedFailureTask<int>(Error.NotFound("Second not found"), 20);
        var task3 = CreateDelayedSuccessTask(3, 15);

        // Act
        var result = await task1
            .ParallelAsync(task2)
            .ParallelAsync(task3)
            .AwaitAsync();

        // Assert
        result.Should().BeFailure();
        result.Error.Should().BeOfType<NotFoundError>()
            .Which.Detail.Should().Be("Second not found");
    }

    [Fact]
    public async Task ParallelAsync_3Tuple_ThirdFails_ReturnsFailure()
    {
        // Arrange
        var task1 = CreateDelayedSuccessTask(1, 10);
        var task2 = CreateDelayedSuccessTask(2, 20);
        var task3 = CreateDelayedFailureTask<int>(Error.Forbidden("Third forbidden"), 15);

        // Act
        var result = await task1
            .ParallelAsync(task2)
            .ParallelAsync(task3)
            .AwaitAsync();

        // Assert
        result.Should().BeFailure();
        result.Error.Should().BeOfType<ForbiddenError>()
            .Which.Detail.Should().Be("Third forbidden");
    }

    [Fact]
    public async Task ParallelAsync_3Tuple_AllFail_CombinesErrors()
    {
        // Arrange
        var task1 = CreateDelayedFailureTask<int>(Error.Validation("First invalid", "field1"), 10);
        var task2 = CreateDelayedFailureTask<int>(Error.Validation("Second invalid", "field2"), 20);
        var task3 = CreateDelayedFailureTask<int>(Error.Validation("Third invalid", "field3"), 15);

        // Act
        var result = await task1
            .ParallelAsync(task2)
            .ParallelAsync(task3)
            .AwaitAsync();

        // Assert
        result.Should().BeFailure();
        result.Error.Should().BeOfType<ValidationError>();
        var validationError = (ValidationError)result.Error;
        validationError.FieldErrors.Should().HaveCount(3);
        validationError.FieldErrors[0].FieldName.Should().Be("field1");
        validationError.FieldErrors[1].FieldName.Should().Be("field2");
        validationError.FieldErrors[2].FieldName.Should().Be("field3");
    }

    [Fact]
    public async Task ParallelAsync_3Tuple_MixedErrorTypes_ReturnsAggregateError()
    {
        // Arrange
        var task1 = CreateDelayedFailureTask<int>(Error.Validation("Validation error"), 10);
        var task2 = CreateDelayedFailureTask<int>(Error.NotFound("Not found"), 20);
        var task3 = CreateDelayedSuccessTask(3, 15);

        // Act
        var result = await task1
            .ParallelAsync(task2)
            .ParallelAsync(task3)
            .AwaitAsync();

        // Assert
        result.Should().BeFailure();
        result.Error.Should().BeOfType<AggregateError>();
        var aggregateError = (AggregateError)result.Error;
        aggregateError.Errors.Should().HaveCount(2);
        aggregateError.Errors[0].Should().BeOfType<ValidationError>();
        aggregateError.Errors[1].Should().BeOfType<NotFoundError>();
    }

    [Fact]
    public async Task ParallelAsync_3Tuple_ExecutesInParallel()
    {
        // Arrange
        var stopwatch = Stopwatch.StartNew();
        var task1 = CreateDelayedSuccessTask(1, 50);
        var task2 = CreateDelayedSuccessTask(2, 50);
        var task3 = CreateDelayedSuccessTask(3, 50);

        // Act
        var result = await task1
            .ParallelAsync(task2)
            .ParallelAsync(task3)
            .AwaitAsync();

        stopwatch.Stop();

        // Assert
        result.Should().BeSuccess();
        // If run sequentially, would take 150ms+. In parallel, should be ~50ms
        // Allow generous margin for CI/slow environments
        stopwatch.ElapsedMilliseconds.Should().BeLessThan(120);
    }

    [Fact]
    public async Task ParallelAsync_3Tuple_DifferentTypes_ReturnsTuple()
    {
        // Arrange
        var task1 = CreateDelayedSuccessTask("text", 10);
        var task2 = CreateDelayedSuccessTask(42, 20);
        var task3 = CreateDelayedSuccessTask(true, 15);

        // Act
        var result = await task1
            .ParallelAsync(task2)
            .ParallelAsync(task3)
            .AwaitAsync();

        // Assert
        result.Should().BeSuccess();
        result.Value.Should().Be(("text", 42, true));
        result.Value.Item1.Should().Be("text");
        result.Value.Item2.Should().Be(42);
        result.Value.Item3.Should().BeTrue();
    }

    [Fact]
    public async Task ParallelAsync_3Tuple_WithBind_ProcessesCombinedResults()
    {
        // Arrange
        var task1 = CreateDelayedSuccessTask(10, 10);
        var task2 = CreateDelayedSuccessTask(20, 20);
        var task3 = CreateDelayedSuccessTask(30, 15);

        // Act
        var result = await task1
            .ParallelAsync(task2)
            .ParallelAsync(task3)
            .AwaitAsync()
            .BindAsync((a, b, c) => Result.Success(a + b + c));

        // Assert
        result.Should().BeSuccess();
        result.Value.Should().Be(60);
    }

    [Fact]
    public async Task ParallelAsync_3Tuple_WithMap_TransformsResult()
    {
        // Arrange
        var task1 = CreateDelayedSuccessTask(1, 10);
        var task2 = CreateDelayedSuccessTask(2, 20);
        var task3 = CreateDelayedSuccessTask(3, 15);

        // Act
        var result = await task1
            .ParallelAsync(task2)
            .ParallelAsync(task3)
            .AwaitAsync()
            .MapAsync(tuple => $"{tuple.Item1}-{tuple.Item2}-{tuple.Item3}");

        // Assert
        result.Should().BeSuccess();
        result.Value.Should().Be("1-2-3");
    }

    [Fact]
    public async Task ParallelAsync_3Tuple_FailureShortCircuitsBind()
    {
        // Arrange
        var task1 = CreateDelayedSuccessTask(10, 10);
        var task2 = CreateDelayedFailureTask<int>(Error.Unexpected("Task failed"), 20);
        var task3 = CreateDelayedSuccessTask(30, 15);
        var bindCalled = false;

        // Act
        var result = await task1
            .ParallelAsync(task2)
            .ParallelAsync(task3)
            .AwaitAsync()
            .BindAsync((a, b, c) =>
            {
                bindCalled = true;
                return Result.Success(a + b + c);
            });

        // Assert
        bindCalled.Should().BeFalse();
        result.Should().BeFailure();
        result.Error.Should().BeOfType<UnexpectedError>();
    }

    #endregion

    #region Other Tuple Sizes (Validation Tests)

    [Fact]
    public async Task ParallelAsync_4Tuple_AllSuccess_ReturnsCombinedTuple()
    {
        // Arrange
        var task1 = CreateDelayedSuccessTask(1, 10);
        var task2 = CreateDelayedSuccessTask(2, 20);
        var task3 = CreateDelayedSuccessTask(3, 15);
        var task4 = CreateDelayedSuccessTask(4, 25);

        // Act
        var result = await task1
            .ParallelAsync(task2)
            .ParallelAsync(task3)
            .ParallelAsync(task4)
            .AwaitAsync();

        // Assert
        result.Should().BeSuccess();
        result.Value.Should().Be((1, 2, 3, 4));
    }

    [Fact]
    public async Task ParallelAsync_4Tuple_OneFails_ReturnsFailure()
    {
        // Arrange
        var task1 = CreateDelayedSuccessTask(1, 10);
        var task2 = CreateDelayedSuccessTask(2, 20);
        var task3 = CreateDelayedFailureTask<int>(Error.Conflict("Conflict occurred"), 15);
        var task4 = CreateDelayedSuccessTask(4, 25);

        // Act
        var result = await task1
            .ParallelAsync(task2)
            .ParallelAsync(task3)
            .ParallelAsync(task4)
            .AwaitAsync();

        // Assert
        result.Should().BeFailure();
        result.Error.Should().BeOfType<ConflictError>();
    }

    [Fact]
    public async Task ParallelAsync_5Tuple_AllSuccess_ReturnsCombinedTuple()
    {
        // Arrange
        var task1 = CreateDelayedSuccessTask(1, 10);
        var task2 = CreateDelayedSuccessTask(2, 20);
        var task3 = CreateDelayedSuccessTask(3, 15);
        var task4 = CreateDelayedSuccessTask(4, 25);
        var task5 = CreateDelayedSuccessTask(5, 30);

        // Act
        var result = await task1
            .ParallelAsync(task2)
            .ParallelAsync(task3)
            .ParallelAsync(task4)
            .ParallelAsync(task5)
            .AwaitAsync();

        // Assert
        result.Should().BeSuccess();
        result.Value.Should().Be((1, 2, 3, 4, 5));
    }

    [Fact]
    public async Task ParallelAsync_6Tuple_AllSuccess_ReturnsCombinedTuple()
    {
        // Arrange
        var task1 = CreateDelayedSuccessTask(1, 10);
        var task2 = CreateDelayedSuccessTask(2, 20);
        var task3 = CreateDelayedSuccessTask(3, 15);
        var task4 = CreateDelayedSuccessTask(4, 25);
        var task5 = CreateDelayedSuccessTask(5, 30);
        var task6 = CreateDelayedSuccessTask(6, 35);

        // Act
        var result = await task1
            .ParallelAsync(task2)
            .ParallelAsync(task3)
            .ParallelAsync(task4)
            .ParallelAsync(task5)
            .ParallelAsync(task6)
            .AwaitAsync();

        // Assert
        result.Should().BeSuccess();
        result.Value.Should().Be((1, 2, 3, 4, 5, 6));
    }

    [Fact]
    public async Task ParallelAsync_7Tuple_AllSuccess_ReturnsCombinedTuple()
    {
        // Arrange
        var task1 = CreateDelayedSuccessTask(1, 10);
        var task2 = CreateDelayedSuccessTask(2, 20);
        var task3 = CreateDelayedSuccessTask(3, 15);
        var task4 = CreateDelayedSuccessTask(4, 25);
        var task5 = CreateDelayedSuccessTask(5, 30);
        var task6 = CreateDelayedSuccessTask(6, 35);
        var task7 = CreateDelayedSuccessTask(7, 40);

        // Act
        var result = await task1
            .ParallelAsync(task2)
            .ParallelAsync(task3)
            .ParallelAsync(task4)
            .ParallelAsync(task5)
            .ParallelAsync(task6)
            .ParallelAsync(task7)
            .AwaitAsync();

        // Assert
        result.Should().BeSuccess();
        result.Value.Should().Be((1, 2, 3, 4, 5, 6, 7));
    }

    [Fact]
    public async Task ParallelAsync_8Tuple_AllSuccess_ReturnsCombinedTuple()
    {
        // Arrange
        var task1 = CreateDelayedSuccessTask(1, 10);
        var task2 = CreateDelayedSuccessTask(2, 20);
        var task3 = CreateDelayedSuccessTask(3, 15);
        var task4 = CreateDelayedSuccessTask(4, 25);
        var task5 = CreateDelayedSuccessTask(5, 30);
        var task6 = CreateDelayedSuccessTask(6, 35);
        var task7 = CreateDelayedSuccessTask(7, 40);
        var task8 = CreateDelayedSuccessTask(8, 45);

        // Act
        var result = await task1
            .ParallelAsync(task2)
            .ParallelAsync(task3)
            .ParallelAsync(task4)
            .ParallelAsync(task5)
            .ParallelAsync(task6)
            .ParallelAsync(task7)
            .ParallelAsync(task8)
            .AwaitAsync();

        // Assert
        result.Should().BeSuccess();
        result.Value.Should().Be((1, 2, 3, 4, 5, 6, 7, 8));
    }

    [Fact]
    public async Task ParallelAsync_9Tuple_AllSuccess_ReturnsCombinedTuple()
    {
        // Arrange
        var task1 = CreateDelayedSuccessTask(1, 10);
        var task2 = CreateDelayedSuccessTask(2, 20);
        var task3 = CreateDelayedSuccessTask(3, 15);
        var task4 = CreateDelayedSuccessTask(4, 25);
        var task5 = CreateDelayedSuccessTask(5, 30);
        var task6 = CreateDelayedSuccessTask(6, 35);
        var task7 = CreateDelayedSuccessTask(7, 40);
        var task8 = CreateDelayedSuccessTask(8, 45);
        var task9 = CreateDelayedSuccessTask(9, 50);

        // Act
        var result = await task1
            .ParallelAsync(task2)
            .ParallelAsync(task3)
            .ParallelAsync(task4)
            .ParallelAsync(task5)
            .ParallelAsync(task6)
            .ParallelAsync(task7)
            .ParallelAsync(task8)
            .ParallelAsync(task9)
            .AwaitAsync();

        // Assert
        result.Should().BeSuccess();
        result.Value.Should().Be((1, 2, 3, 4, 5, 6, 7, 8, 9));
    }

    [Fact]
    public async Task ParallelAsync_9Tuple_MultipleFail_CombinesErrors()
    {
        // Arrange
        var task1 = CreateDelayedSuccessTask(1, 10);
        var task2 = CreateDelayedFailureTask<int>(Error.Validation("Error 2"), 20);
        var task3 = CreateDelayedSuccessTask(3, 15);
        var task4 = CreateDelayedSuccessTask(4, 25);
        var task5 = CreateDelayedFailureTask<int>(Error.Validation("Error 5"), 30);
        var task6 = CreateDelayedSuccessTask(6, 35);
        var task7 = CreateDelayedSuccessTask(7, 40);
        var task8 = CreateDelayedFailureTask<int>(Error.Validation("Error 8"), 45);
        var task9 = CreateDelayedSuccessTask(9, 50);

        // Act
        var result = await task1
            .ParallelAsync(task2)
            .ParallelAsync(task3)
            .ParallelAsync(task4)
            .ParallelAsync(task5)
            .ParallelAsync(task6)
            .ParallelAsync(task7)
            .ParallelAsync(task8)
            .ParallelAsync(task9)
            .AwaitAsync();

        // Assert
        result.Should().BeFailure();
        result.Error.Should().BeOfType<ValidationError>();
    }

    #endregion

    #region Real-World Scenarios

    [Fact]
    public async Task ParallelAsync_FetchUserData_AllSucceed()
    {
        // Arrange - Simulate fetching user data from multiple sources
        var userProfileTask = CreateDelayedSuccessTask("John Doe", 30);
        var orders = new[] { "Order1", "Order2" };
        var userOrdersTask = CreateDelayedSuccessTask(orders, 40);
        var userPreferencesTask = CreateDelayedSuccessTask("Dark Mode", 20);

        // Act
        var result = await userProfileTask
            .ParallelAsync(userOrdersTask)
            .ParallelAsync(userPreferencesTask)
            .AwaitAsync()
            .MapAsync(data => new
            {
                Profile = data.Item1,
                OrderCount = data.Item2.Length,
                Theme = data.Item3
            });

        // Assert
        result.Should().BeSuccess();
        result.Value.Profile.Should().Be("John Doe");
        result.Value.OrderCount.Should().Be(2);
        result.Value.Theme.Should().Be("Dark Mode");
    }

    [Fact]
    public async Task ParallelAsync_ValidationScenario_CombinesAllErrors()
    {
        // Arrange - Simulate multiple validation failures
        var emailTask = CreateDelayedFailureTask<string>(
            Error.Validation("Invalid email format", "email"), 10);
        var phoneTask = CreateDelayedFailureTask<string>(
            Error.Validation("Invalid phone number", "phone"), 15);
        var ageTask = CreateDelayedFailureTask<int>(
            Error.Validation("Age must be 18+", "age"), 20);

        // Act
        var result = await emailTask
            .ParallelAsync(phoneTask)
            .ParallelAsync(ageTask)
            .AwaitAsync();

        // Assert
        result.Should().BeFailure();
        result.Error.Should().BeOfType<ValidationError>();
        var validationError = (ValidationError)result.Error;
        validationError.FieldErrors.Should().HaveCount(3);
    }

    [Fact]
    public async Task ParallelAsync_FraudDetection_AllChecksMustPass()
    {
        // Arrange - Simulate parallel fraud detection checks
        var blacklistCheckTask = CreateDelayedSuccessTask("Clear", 25);
        var velocityCheckTask = CreateDelayedSuccessTask("Normal", 30);
        var geolocationCheckTask = CreateDelayedFailureTask<string>(
            Error.Forbidden("Suspicious location detected"), 20);

        // Act
        var result = await blacklistCheckTask
            .ParallelAsync(velocityCheckTask)
            .ParallelAsync(geolocationCheckTask)
            .AwaitAsync();

        // Assert - Should fail if any check fails
        result.Should().BeFailure();
        result.Error.Should().BeOfType<ForbiddenError>();
        result.Error.Detail.Should().Contain("Suspicious location");
    }

    #endregion

    #region Helper Methods

    private static async Task<Result<T>> CreateDelayedSuccessTask<T>(T value, int delayMs)
    {
        await Task.Delay(delayMs);
        return Result.Success(value);
    }

    private static async Task<Result<T>> CreateDelayedFailureTask<T>(Error error, int delayMs)
    {
        await Task.Delay(delayMs);
        return Result.Failure<T>(error);
    }

    #endregion
}

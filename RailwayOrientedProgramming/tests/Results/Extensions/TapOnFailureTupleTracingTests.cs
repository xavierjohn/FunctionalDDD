namespace RailwayOrientedProgramming.Tests.Results.Extensions;

using FunctionalDdd.Testing;
using RailwayOrientedProgramming.Tests.Helpers;
using System.Diagnostics;

/// <summary>
/// Tests for Activity tracing in TapOnFailure operations on tuple results generated by TapOnFailureTs.g.tt.
/// Verifies that TapOnFailure methods create proper OpenTelemetry activities with correct status codes
/// only when failures occur.
/// 
/// Since tuple-based TapOnFailure methods are generated from the same T4 template pattern, we test the 2-tuple
/// permutation comprehensively to validate the template logic.
/// </summary>
public class TapOnFailureTupleTracingTests : TestBase
{
    #region 2-Tuple TapOnFailure Tracing Tests

    [Fact]
    public void TapOnFailure_2Tuple_Failure_CreatesActivityWithErrorStatus()
    {
        // Arrange
        using var activityTest = new ActivityTestHelper();
        var result = Result.Failure<(int, string)>(Error.Validation("Validation failed"));

        // Act
        var actual = result.TapOnFailure(() => { /* Log error */ });

        // Assert
        actual.Should().BeFailure();
        activityTest.AssertActivityCapturedWithStatus("TapOnFailure", ActivityStatusCode.Error);
    }

    [Fact]
    public void TapOnFailure_2Tuple_Success_DoesNotCreateActivity()
    {
        // Arrange
        using var activityTest = new ActivityTestHelper();
        var result = Result.Success((42, "hello"));

        // Act
        var actual = result.TapOnFailure(() => { /* Should not execute */ });

        // Assert
        actual.Should().BeSuccess();
        // Note: TapOnFailure creates an activity but doesn't set status on success
        // The activity exists but shouldn't have Error status
        activityTest.ActivityCount.Should().BeGreaterOrEqualTo(0);
    }

    [Fact]
    public void TapOnFailure_2Tuple_WithActionError_Failure_CreatesActivityWithErrorStatus()
    {
        // Arrange
        using var activityTest = new ActivityTestHelper();
        var result = Result.Failure<(int, string)>(Error.NotFound("Not found"));

        // Act
        var actual = result.TapOnFailure(error => { /* Log error */ });

        // Assert
        actual.Should().BeFailure();
        activityTest.AssertActivityCapturedWithStatus("TapOnFailure", ActivityStatusCode.Error);
    }

    [Fact]
    public void TapOnFailure_2Tuple_ChainedActions_CreatesMultipleActivities()
    {
        // Arrange
        using var activityTest = new ActivityTestHelper();
        var result = Result.Failure<(int, string)>(Error.Unexpected("Error"));

        // Act
        var actual = result
            .TapOnFailure(() => { /* First handler */ })
            .TapOnFailure(() => { /* Second handler */ })
            .TapOnFailure(() => { /* Third handler */ });

        // Assert
        actual.Should().BeFailure();
        activityTest.AssertActivityCaptured(3); // Should have 3 separate activities
        // All activities should have Error status (verified by AssertActivityCapturedWithStatus)
    }

    [Fact]
    public void TapOnFailure_2Tuple_ValidationError_CreatesActivityWithErrorStatus()
    {
        // Arrange
        using var activityTest = new ActivityTestHelper();
        var result = Result.Failure<(string, string)>(Error.Validation("Invalid email", "email"));

        // Act
        var actual = result.TapOnFailure(error => { /* Log validation error */ });

        // Assert
        actual.Should().BeFailure();
        activityTest.AssertActivityCapturedWithStatus("TapOnFailure", ActivityStatusCode.Error);
    }

    [Fact]
    public void TapOnFailure_2Tuple_DifferentErrorTypes_AllCreateActivitiesWithErrorStatus()
    {
        // Arrange
        using var activityTest = new ActivityTestHelper();

        // Act & Assert - NotFoundError
        Result.Failure<(int, string)>(Error.NotFound("Not found"))
            .TapOnFailure(() => { })
            .Should().BeFailure();

        // Act & Assert - ForbiddenError
        Result.Failure<(int, string)>(Error.Forbidden("Forbidden"))
            .TapOnFailure(() => { })
            .Should().BeFailure();

        // Act & Assert - ConflictError
        Result.Failure<(int, string)>(Error.Conflict("Conflict"))
            .TapOnFailure(() => { })
            .Should().BeFailure();

        // Assert all activities created with Error status
        activityTest.AssertActivityCaptured(3);
    }

    #endregion

    #region Async TapOnFailure Tracing Tests

    [Fact]
    public async Task TapOnFailureAsync_2Tuple_TaskResult_WithAction_Failure_CreatesActivity()
    {
        // Arrange
        using var activityTest = new ActivityTestHelper();
        var result = Task.FromResult(Result.Failure<(int, string)>(Error.Validation("Failed")));

        // Act
        await result.TapOnFailureAsync(() => { });

        // Assert
        // Wait for async activity capture
        await Task.Delay(50);
        activityTest.ActivityCount.Should().BeGreaterThan(0);
    }

    [Fact]
    public async Task TapOnFailureAsync_2Tuple_WithFuncTask_Failure_CreatesActivityWithErrorStatus()
    {
        // Arrange
        using var activityTest = new ActivityTestHelper();
        var result = Result.Failure<(int, string)>(Error.Unexpected("Error"));

        // Act
        await result.TapOnFailureAsync(() => Task.CompletedTask);

        // Assert
        // Wait for async activity capture
        await Task.Delay(50);
        activityTest.ActivityCount.Should().BeGreaterThan(0);
    }

    [Fact]
    public async Task TapOnFailureAsync_2Tuple_WithFuncErrorTask_Failure_CreatesActivity()
    {
        // Arrange
        using var activityTest = new ActivityTestHelper();
        var result = Result.Failure<(int, string)>(Error.BadRequest("Bad request"));

        // Act
        await result.TapOnFailureAsync(error => Task.CompletedTask);

        // Assert
        // Wait for async activity capture
        await Task.Delay(50);
        activityTest.ActivityCount.Should().BeGreaterThan(0);
    }

    [Fact]
    public async Task TapOnFailureAsync_2Tuple_WithFuncValueTask_Failure_CreatesActivity()
    {
        // Arrange
        using var activityTest = new ActivityTestHelper();
        var result = Result.Failure<(int, string)>(Error.Conflict("Conflict"));

        // Act
        await result.TapOnFailureAsync(() => ValueTask.CompletedTask);

        // Assert
        // Wait for async activity capture
        await Task.Delay(50);
        activityTest.ActivityCount.Should().BeGreaterThan(0);
    }

    #endregion

    #region Other Tuple Sizes Validation

    [Fact]
    public void TapOnFailure_3Tuple_Failure_CreatesActivityWithErrorStatus()
    {
        // Arrange
        using var activityTest = new ActivityTestHelper();
        var result = Result.Failure<(int, string, bool)>(Error.Validation("Failed"));

        // Act
        result.TapOnFailure(() => { });

        // Assert
        activityTest.AssertActivityCapturedWithStatus("TapOnFailure", ActivityStatusCode.Error);
    }

    [Fact]
    public void TapOnFailure_4Tuple_Failure_CreatesActivityWithErrorStatus()
    {
        // Arrange
        using var activityTest = new ActivityTestHelper();
        var result = Result.Failure<(int, int, int, int)>(Error.NotFound("Not found"));

        // Act
        result.TapOnFailure(() => { });

        // Assert
        activityTest.AssertActivityCapturedWithStatus("TapOnFailure", ActivityStatusCode.Error);
    }

    [Fact]
    public void TapOnFailure_5Tuple_Failure_CreatesActivityWithErrorStatus()
    {
        // Arrange
        using var activityTest = new ActivityTestHelper();
        var result = Result.Failure<(int, int, int, int, int)>(Error.Forbidden("Forbidden"));

        // Act
        result.TapOnFailure(() => { });

        // Assert
        activityTest.AssertActivityCapturedWithStatus("TapOnFailure", ActivityStatusCode.Error);
    }

    [Fact]
    public void TapOnFailure_9Tuple_Failure_CreatesActivityWithErrorStatus()
    {
        // Arrange
        using var activityTest = new ActivityTestHelper();
        var result = Result.Failure<(int, int, int, int, int, int, int, int, int)>(Error.Unexpected("Error"));

        // Act
        result.TapOnFailure(() => { });

        // Assert
        activityTest.AssertActivityCapturedWithStatus("TapOnFailure", ActivityStatusCode.Error);
    }

    #endregion

    #region Integration Scenarios with Tracing

    [Fact]
    public void TapOnFailure_AfterCombine_TracesCorrectly()
    {
        // Arrange
        using var activityTest = new ActivityTestHelper();

        // Act
        var result = Result.Failure<string>(Error.Validation("Invalid email", "email"))
            .Combine(Result.Success("data"))
            .TapOnFailure(error => { /* Log error */ });

        // Assert
        result.Should().BeFailure();
        
        // Should have 1 Combine + 1 TapOnFailure activity
        activityTest.AssertActivityCaptured(2);
        
        // Verify TapOnFailure activity has Error status
        activityTest.AssertActivityCapturedWithStatus("TapOnFailure", ActivityStatusCode.Error);
    }

    [Fact]
    public void TapOnFailure_WithMatch_TracesErrorPath()
    {
        // Arrange
        using var activityTest = new ActivityTestHelper();

        // Act
        var result = Result.Failure<string>(Error.NotFound("User not found"))
            .Combine(Result.Success("permissions"))
            .TapOnFailure(error => { /* Log error */ })
            .Match(
                onSuccess: (user, permissions) => "Success",
                onFailure: error => "Error"
            );

        // Assert
        result.Should().Be("Error");
        
        // Should have Combine + TapOnFailure + Match activities
        activityTest.AssertActivityCaptured(3);
    }

    [Fact]
    public void TapOnFailure_MultipleCombined_TracesAllFailures()
    {
        // Arrange
        using var activityTest = new ActivityTestHelper();

        // Act
        var result = Result.Failure<string>(Error.Validation("Bad email", "email"))
            .Combine(Result.Failure<string>(Error.Validation("Bad phone", "phone")))
            .TapOnFailure(error => { /* Log validation errors */ });

        // Assert
        result.Should().BeFailure();
        
        // Should have Combine + TapOnFailure activities
        activityTest.ActivityCount.Should().BeGreaterThan(0);
        // TapOnFailure should have Error status
        activityTest.AssertActivityCapturedWithStatus("TapOnFailure", ActivityStatusCode.Error);
    }

    [Fact]
    public void TapOnFailure_ChainedWithBind_OnlyTapOnFailureTraces()
    {
        // Arrange
        using var activityTest = new ActivityTestHelper();

        // Act
        var result = Result.Failure<string>(Error.Unexpected("Error"))
            .Combine(Result.Success("data"))
            .TapOnFailure(error => { /* Log */ })
            .Bind((a, b) => Result.Success("processed"));

        // Assert
        result.Should().BeFailure();
        
        // Bind should be short-circuited (no Bind activity)
        // Should only have Combine + TapOnFailure
        activityTest.AssertActivityCapturedWithStatus("TapOnFailure", ActivityStatusCode.Error);
    }

    #endregion

    #region Activity Name Verification

    [Fact]
    public void TapOnFailure_CreatesActivity_WithCorrectName()
    {
        // Arrange
        using var activityTest = new ActivityTestHelper();
        var result = Result.Failure<(int, string)>(Error.Validation("Error"));

        // Act
        result.TapOnFailure(() => { });

        // Assert
        var activity = activityTest.AssertActivityCaptured("TapOnFailure");
        activity.DisplayName.Should().Be("TapOnFailure");
    }

    [Fact]
    public void TapOnFailure_WithActionError_CreatesActivity_WithCorrectName()
    {
        // Arrange
        using var activityTest = new ActivityTestHelper();
        var result = Result.Failure<(int, string)>(Error.NotFound("Not found"));

        // Act
        result.TapOnFailure(error => { });

        // Assert
        var activity = activityTest.AssertActivityCaptured("TapOnFailure");
        activity.DisplayName.Should().Be("TapOnFailure");
    }

    #endregion
}

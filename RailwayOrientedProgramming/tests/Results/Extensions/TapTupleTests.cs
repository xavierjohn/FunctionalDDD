namespace RailwayOrientedProgramming.Tests.Results.Extensions;

using FunctionalDdd.Testing;

/// <summary>
/// Functional tests for Tap operations on tuple results generated by TapTs.g.tt.
/// Tests side effect execution on success paths for combined results without modifying the result.
/// 
/// Since all tuple sizes (2-9) are generated from the same T4 template, we test the 2-tuple
/// permutation comprehensively and validate other sizes work correctly.
/// </summary>
public class TapTupleTests : TestBase
{
    private bool _actionExecuted;
    private int _executionCount;
    private (int, string)? _capturedTuple;

    public TapTupleTests()
    {
        _actionExecuted = false;
        _executionCount = 0;
        _capturedTuple = null;
    }

    #region 2-Tuple Tap Tests (Comprehensive Coverage)

    [Fact]
    public void Tap_2Tuple_Success_ExecutesAction()
    {
        // Arrange
        var result = Result.Success((42, "hello"));

        // Act
        var actual = result.Tap((a, b) => _actionExecuted = true);

        // Assert
        _actionExecuted.Should().BeTrue();
        actual.Should().BeSuccess();
        actual.Value.Should().Be((42, "hello"));
    }

    [Fact]
    public void Tap_2Tuple_Failure_DoesNotExecute()
    {
        // Arrange
        var result = Result.Failure<(int, string)>(Error.Validation("Validation failed"));

        // Act
        var actual = result.Tap((a, b) => _actionExecuted = true);

        // Assert
        _actionExecuted.Should().BeFalse();
        actual.Should().BeFailure();
        actual.Error.Should().BeOfType<ValidationError>();
    }

    [Fact]
    public void Tap_2Tuple_Success_DestructuresTuple()
    {
        // Arrange
        var result = Result.Success((42, "hello"));

        // Act
        var actual = result.Tap((num, str) => _capturedTuple = (num, str));

        // Assert
        _capturedTuple.Should().NotBeNull();
        _capturedTuple.Should().Be((42, "hello"));
        actual.Should().BeSuccess();
    }

    [Fact]
    public void Tap_2Tuple_PreservesOriginalResult()
    {
        // Arrange
        var originalResult = Result.Success((42, "hello"));

        // Act
        var actual = originalResult.Tap((a, b) => _actionExecuted = true);

        // Assert
        actual.Should().BeSuccess();
        actual.Value.Should().Be((42, "hello"));
        actual.Value.Should().Be(originalResult.Value);
    }

    [Fact]
    public void Tap_2Tuple_ChainedActions_ExecutesAll()
    {
        // Arrange
        var result = Result.Success((42, "hello"));

        // Act
        var actual = result
            .Tap((a, b) => _executionCount++)
            .Tap((a, b) => _executionCount++)
            .Tap((a, b) => _executionCount++);

        // Assert
        _executionCount.Should().Be(3);
        actual.Should().BeSuccess();
    }

    [Fact]
    public void Tap_2Tuple_DifferentTypes_Works()
    {
        // Arrange
        var result = Result.Success(("text", 123));
        var capturedString = string.Empty;
        var capturedInt = 0;

        // Act
        var actual = result.Tap((str, num) =>
        {
            capturedString = str;
            capturedInt = num;
        });

        // Assert
        capturedString.Should().Be("text");
        capturedInt.Should().Be(123);
        actual.Should().BeSuccess();
    }

    [Fact]
    public void Tap_2Tuple_AfterCombine_LogsValues()
    {
        // Arrange
        var loggedValues = new List<string>();

        // Act
        var result = Result.Success("John")
            .Combine(Result.Success("Doe"))
            .Tap((first, last) => loggedValues.Add($"{first} {last}"));

        // Assert
        result.Should().BeSuccess();
        loggedValues.Should().ContainSingle();
        loggedValues[0].Should().Be("John Doe");
    }

    #endregion

    #region 2-Tuple Async Tests

    [Fact]
    public async Task TapAsync_2Tuple_TaskResult_Success_ExecutesAction()
    {
        // Arrange
        var result = Task.FromResult(Result.Success((42, "hello")));

        // Act
        var actual = await result.TapAsync((a, b) => _actionExecuted = true);

        // Assert
        _actionExecuted.Should().BeTrue();
        actual.Should().BeSuccess();
    }

    [Fact]
    public async Task TapAsync_2Tuple_TaskResult_Failure_DoesNotExecute()
    {
        // Arrange
        var result = Task.FromResult(Result.Failure<(int, string)>(Error.NotFound("Not found")));

        // Act
        var actual = await result.TapAsync((a, b) => _actionExecuted = true);

        // Assert
        _actionExecuted.Should().BeFalse();
        actual.Should().BeFailure();
    }

    [Fact]
    public async Task TapAsync_2Tuple_WithFuncTask_Success_ExecutesFunction()
    {
        // Arrange
        var result = Result.Success((42, "hello"));

        // Act
        var actual = await result.TapAsync((a, b) =>
        {
            _actionExecuted = true;
            return Task.CompletedTask;
        });

        // Assert
        _actionExecuted.Should().BeTrue();
        actual.Should().BeSuccess();
    }

    [Fact]
    public async Task TapAsync_2Tuple_WithFuncTask_Failure_DoesNotExecute()
    {
        // Arrange
        var result = Result.Failure<(int, string)>(Error.Unexpected("Error"));

        // Act
        var actual = await result.TapAsync((a, b) =>
        {
            _actionExecuted = true;
            return Task.CompletedTask;
        });

        // Assert
        _actionExecuted.Should().BeFalse();
        actual.Should().BeFailure();
    }

    [Fact]
    public async Task TapAsync_2Tuple_TaskResult_WithFuncTask_Success()
    {
        // Arrange
        var result = Task.FromResult(Result.Success((42, "hello")));

        // Act
        var actual = await result.TapAsync((a, b) =>
        {
            _actionExecuted = true;
            return Task.CompletedTask;
        });

        // Assert
        _actionExecuted.Should().BeTrue();
        actual.Should().BeSuccess();
    }

    [Fact]
    public async Task TapAsync_2Tuple_ValueTask_WithAction_Success()
    {
        // Arrange
        var result = ValueTask.FromResult(Result.Success((42, "hello")));

        // Act
        var actual = await result.TapAsync((a, b) => _actionExecuted = true);

        // Assert
        _actionExecuted.Should().BeTrue();
        actual.Should().BeSuccess();
    }

    [Fact]
    public async Task TapAsync_2Tuple_WithFuncValueTask_Success()
    {
        // Arrange
        var result = Result.Success((42, "hello"));

        // Act
        var actual = await result.TapAsync((a, b) =>
        {
            _actionExecuted = true;
            return ValueTask.CompletedTask;
        });

        // Assert
        _actionExecuted.Should().BeTrue();
        actual.Should().BeSuccess();
    }

    [Fact]
    public async Task TapAsync_2Tuple_ValueTaskResult_WithFuncValueTask_Success()
    {
        // Arrange
        var result = ValueTask.FromResult(Result.Success((42, "hello")));

        // Act
        var actual = await result.TapAsync((a, b) =>
        {
            _actionExecuted = true;
            return ValueTask.CompletedTask;
        });

        // Assert
        _actionExecuted.Should().BeTrue();
        actual.Should().BeSuccess();
    }

    #endregion

    #region Other Tuple Sizes (Validation Tests)

    [Fact]
    public void Tap_3Tuple_Success_ExecutesAction()
    {
        // Arrange
        var result = Result.Success((1, "two", true));

        // Act
        var actual = result.Tap((a, b, c) => _actionExecuted = true);

        // Assert
        _actionExecuted.Should().BeTrue();
        actual.Should().BeSuccess();
        actual.Value.Should().Be((1, "two", true));
    }

    [Fact]
    public void Tap_4Tuple_Success_ExecutesAction()
    {
        // Arrange
        var result = Result.Success((1, 2, 3, 4));

        // Act
        var actual = result.Tap((a, b, c, d) => _actionExecuted = true);

        // Assert
        _actionExecuted.Should().BeTrue();
        actual.Should().BeSuccess();
    }

    [Fact]
    public void Tap_5Tuple_Success_ExecutesAction()
    {
        // Arrange
        var result = Result.Success((1, 2, 3, 4, 5));

        // Act
        var actual = result.Tap((a, b, c, d, e) => _actionExecuted = true);

        // Assert
        _actionExecuted.Should().BeTrue();
        actual.Should().BeSuccess();
    }

    [Fact]
    public void Tap_6Tuple_Success_ExecutesAction()
    {
        // Arrange
        var result = Result.Success((1, 2, 3, 4, 5, 6));

        // Act
        var actual = result.Tap((a, b, c, d, e, f) => _actionExecuted = true);

        // Assert
        _actionExecuted.Should().BeTrue();
        actual.Should().BeSuccess();
    }

    [Fact]
    public void Tap_7Tuple_Success_ExecutesAction()
    {
        // Arrange
        var result = Result.Success((1, 2, 3, 4, 5, 6, 7));

        // Act
        var actual = result.Tap((a, b, c, d, e, f, g) => _actionExecuted = true);

        // Assert
        _actionExecuted.Should().BeTrue();
        actual.Should().BeSuccess();
    }

    [Fact]
    public void Tap_8Tuple_Success_ExecutesAction()
    {
        // Arrange
        var result = Result.Success((1, 2, 3, 4, 5, 6, 7, 8));

        // Act
        var actual = result.Tap((a, b, c, d, e, f, g, h) => _actionExecuted = true);

        // Assert
        _actionExecuted.Should().BeTrue();
        actual.Should().BeSuccess();
    }

    [Fact]
    public void Tap_9Tuple_Success_ExecutesAction()
    {
        // Arrange
        var result = Result.Success((1, 2, 3, 4, 5, 6, 7, 8, 9));

        // Act
        var actual = result.Tap((a, b, c, d, e, f, g, h, i) => _actionExecuted = true);

        // Assert
        _actionExecuted.Should().BeTrue();
        actual.Should().BeSuccess();
    }

    [Fact]
    public void Tap_9Tuple_Failure_DoesNotExecute()
    {
        // Arrange
        var result = Result.Failure<(int, int, int, int, int, int, int, int, int)>(Error.Validation("Invalid"));

        // Act
        var actual = result.Tap((a, b, c, d, e, f, g, h, i) => _actionExecuted = true);

        // Assert
        _actionExecuted.Should().BeFalse();
        actual.Should().BeFailure();
    }

    #endregion

    #region Real-World Scenarios

    [Fact]
    public void Tap_AfterMultipleCombine_LogsAllValues()
    {
        // Arrange
        var loggedValues = new List<string>();

        // Act
        var result = Result.Success("user@example.com")
            .Combine(Result.Success("John"))
            .Combine(Result.Success("Doe"))
            .Tap((email, first, last) =>
                loggedValues.Add($"{first} {last} <{email}>"));

        // Assert
        result.Should().BeSuccess();
        loggedValues.Should().ContainSingle();
        loggedValues[0].Should().Be("John Doe <user@example.com>");
    }

    [Fact]
    public async Task TapAsync_SendNotification_OnSuccess()
    {
        // Arrange
        var notificationsSent = new List<string>();

        // Act
        var result = await Result.Success("user@example.com")
            .Combine(Result.Success("Welcome"))
            .TapAsync((string email, string message) =>
            {
                notificationsSent.Add($"Sent '{message}' to {email}");
                return Task.CompletedTask;
            });

        // Assert
        result.Should().BeSuccess();
        notificationsSent.Should().ContainSingle();
        notificationsSent[0].Should().Be("Sent 'Welcome' to user@example.com");
    }

    [Fact]
    public void Tap_IncrementMetrics_OnSuccess()
    {
        // Arrange
        var metrics = new Dictionary<string, int>();

        // Act
        var result = Result.Success(("CREATE", "User"))
            .Tap((action, entity) =>
                metrics[$"{action}_{entity}"] = metrics.GetValueOrDefault($"{action}_{entity}") + 1);

        Result.Success(("CREATE", "User"))
            .Tap((action, entity) =>
                metrics[$"{action}_{entity}"] = metrics.GetValueOrDefault($"{action}_{entity}") + 1);

        Result.Success(("UPDATE", "User"))
            .Tap((action, entity) =>
                metrics[$"{action}_{entity}"] = metrics.GetValueOrDefault($"{action}_{entity}") + 1);

        // Assert
        metrics["CREATE_User"].Should().Be(2);
        metrics["UPDATE_User"].Should().Be(1);
    }

    [Fact]
    public void Tap_ChainedWithBind_ExecutesInOrder()
    {
        // Arrange
        var executionOrder = new List<string>();

        // Act
        var result = Result.Success("John")
            .Combine(Result.Success("Doe"))
            .Tap((first, last) => executionOrder.Add($"Tap: {first} {last}"))
            .Bind((first, last) =>
            {
                executionOrder.Add($"Bind: {first} {last}");
                return Result.Success($"{first} {last}".ToUpperInvariant());
            })
            .Tap(fullName => executionOrder.Add($"Tap2: {fullName}"));

        // Assert
        result.Should().BeSuccess();
        result.Value.Should().Be("JOHN DOE");
        executionOrder.Should().HaveCount(3);
        executionOrder[0].Should().Be("Tap: John Doe");
        executionOrder[1].Should().Be("Bind: John Doe");
        executionOrder[2].Should().Be("Tap2: JOHN DOE");
    }

    [Fact]
    public void Tap_FailureAfterCombine_DoesNotExecute()
    {
        // Arrange
        var loggedMessages = new List<string>();

        // Act
        var result = Result.Success("valid")
            .Combine(Result.Failure<string>(Error.Validation("Invalid")))
            .Tap((a, b) => loggedMessages.Add("Should not execute"));

        // Assert
        result.Should().BeFailure();
        loggedMessages.Should().BeEmpty();
    }

    [Fact]
    public async Task TapAsync_ComplexPipeline_ExecutesAllTaps()
    {
        // Arrange
        var logs = new List<string>();

        // Act
        var result = await Result.Success("user@example.com")
            .Combine(Result.Success("password123"))
            .TapAsync((email, password) =>
            {
                logs.Add($"Validating {email}");
                return Task.CompletedTask;
            })
            .BindAsync((email, password) => Task.FromResult(Result.Success($"User_{email}")))
            .TapAsync(userId =>
            {
                logs.Add($"Created {userId}");
                return Task.CompletedTask;
            });

        // Assert
        result.Should().BeSuccess();
        logs.Should().HaveCount(2);
        logs[0].Should().Be("Validating user@example.com");
        logs[1].Should().Be("Created User_user@example.com");
    }

    #endregion
}
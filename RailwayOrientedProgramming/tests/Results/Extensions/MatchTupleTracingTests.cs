namespace RailwayOrientedProgramming.Tests.Results.Extensions;

using FunctionalDdd.Testing;
using RailwayOrientedProgramming.Tests.Helpers;
using System.Diagnostics;

/// <summary>
/// Tests for Activity tracing in MatchTuple operations generated by MatchTupleTs.g.tt.
/// Verifies that Match and Switch methods create proper OpenTelemetry activities with correct status codes.
/// 
/// Since tuple-based methods are generated from the same T4 template pattern, we test the 2-tuple
/// permutation comprehensively to validate the template logic.
/// </summary>
public class MatchTupleTracingTests : TestBase
{
    #region Match 2-Tuple Tracing Tests

    [Fact]
    public void Match_2Tuple_Success_CreatesActivityWithOkStatus()
    {
        // Arrange
        using var activityTest = new ActivityTestHelper();
        var result = Result.Success((42, "hello"));

        // Act
        var output = result.Match(
            onSuccess: (num, str) => $"{num}-{str}",
            onFailure: err => "Error"
        );

        // Assert
        output.Should().Be("42-hello");
        activityTest.AssertActivityCapturedWithStatus("Match", ActivityStatusCode.Ok);
    }

    [Fact]
    public void Match_2Tuple_Failure_CreatesActivityWithErrorStatus()
    {
        // Arrange
        using var activityTest = new ActivityTestHelper();
        var result = Result.Failure<(int, string)>(Error.NotFound("Not found"));

        // Act
        var output = result.Match(
            onSuccess: (num, str) => "Success",
            onFailure: err => err.Detail
        );

        // Assert
        output.Should().Be("Not found");
        activityTest.AssertActivityCapturedWithStatus("Match", ActivityStatusCode.Error);
    }

    [Fact]
    public void Match_2Tuple_ValidationError_CreatesActivityWithErrorStatus()
    {
        // Arrange
        using var activityTest = new ActivityTestHelper();
        var result = Result.Failure<(string, string)>(Error.Validation("Invalid email", "email"));

        // Act
        var output = result.Match(
            onSuccess: (email, name) => "Success",
            onFailure: err => err.Code
        );

        // Assert
        output.Should().Be("validation.error");
        activityTest.AssertActivityCapturedWithStatus("Match", ActivityStatusCode.Error);
    }

    [Fact]
    public void Match_2Tuple_DifferentTypes_CreatesActivityWithOkStatus()
    {
        // Arrange
        using var activityTest = new ActivityTestHelper();
        var result = Result.Success((true, 3.14));

        // Act
        var output = result.Match(
            onSuccess: (flag, pi) => flag ? pi : 0.0,
            onFailure: _ => 0.0
        );

        // Assert
        output.Should().Be(3.14);
        activityTest.AssertActivityCapturedWithStatus("Match", ActivityStatusCode.Ok);
    }

    #endregion

    #region Switch 2-Tuple Tracing Tests

    [Fact]
    public void Switch_2Tuple_Success_CreatesActivityWithOkStatus()
    {
        // Arrange
        using var activityTest = new ActivityTestHelper();
        var result = Result.Success((42, "hello"));
        var executed = false;

        // Act
        result.Switch(
            onSuccess: (num, str) => executed = true,
            onFailure: _ => { }
        );

        // Assert
        executed.Should().BeTrue();
        activityTest.AssertActivityCapturedWithStatus("Switch", ActivityStatusCode.Ok);
    }

    [Fact]
    public void Switch_2Tuple_Failure_CreatesActivityWithErrorStatus()
    {
        // Arrange
        using var activityTest = new ActivityTestHelper();
        var result = Result.Failure<(int, string)>(Error.Unexpected("Server error"));
        var errorLogged = false;

        // Act
        result.Switch(
            onSuccess: (num, str) => { },
            onFailure: err => errorLogged = true
        );

        // Assert
        errorLogged.Should().BeTrue();
        activityTest.AssertActivityCapturedWithStatus("Switch", ActivityStatusCode.Error);
    }

    [Fact]
    public void Switch_2Tuple_Success_SideEffects_TracesOk()
    {
        // Arrange
        using var activityTest = new ActivityTestHelper();
        var result = Result.Success((5, 10));
        var sum = 0;

        // Act
        result.Switch(
            onSuccess: (a, b) => sum = a + b,
            onFailure: _ => sum = -1
        );

        // Assert
        sum.Should().Be(15);
        activityTest.AssertActivityCapturedWithStatus("Switch", ActivityStatusCode.Ok);
    }

    [Fact]
    public void Switch_2Tuple_Failure_SideEffects_TracesError()
    {
        // Arrange
        using var activityTest = new ActivityTestHelper();
        var result = Result.Failure<(int, int)>(Error.Forbidden("Access denied"));
        var errorCode = "";

        // Act
        result.Switch(
            onSuccess: (a, b) => { },
            onFailure: err => errorCode = err.Code
        );

        // Assert
        errorCode.Should().Be("forbidden.error");
        activityTest.AssertActivityCapturedWithStatus("Switch", ActivityStatusCode.Error);
    }

    #endregion

    #region Other Tuple Sizes Validation

    [Fact]
    public void Match_3Tuple_Success_CreatesActivityWithOkStatus()
    {
        // Arrange
        using var activityTest = new ActivityTestHelper();
        var result = Result.Success((1, "two", 3.0));

        // Act
        var output = result.Match(
            onSuccess: (i, s, d) => $"{i}-{s}-{d}",
            onFailure: _ => "Error"
        );

        // Assert
        output.Should().Be("1-two-3");
        activityTest.AssertActivityCapturedWithStatus("Match", ActivityStatusCode.Ok);
    }

    [Fact]
    public void Match_3Tuple_Failure_CreatesActivityWithErrorStatus()
    {
        // Arrange
        using var activityTest = new ActivityTestHelper();
        var result = Result.Failure<(int, string, double)>(Error.Conflict("Conflict"));

        // Act
        var output = result.Match(
            onSuccess: (i, s, d) => "Success",
            onFailure: err => err.Detail
        );

        // Assert
        output.Should().Be("Conflict");
        activityTest.AssertActivityCapturedWithStatus("Match", ActivityStatusCode.Error);
    }

    [Fact]
    public void Match_4Tuple_Success_CreatesActivityWithOkStatus()
    {
        // Arrange
        using var activityTest = new ActivityTestHelper();
        var result = Result.Success((1, 2, 3, 4));

        // Act
        var sum = result.Match(
            onSuccess: (a, b, c, d) => a + b + c + d,
            onFailure: _ => 0
        );

        // Assert
        sum.Should().Be(10);
        activityTest.AssertActivityCapturedWithStatus("Match", ActivityStatusCode.Ok);
    }

    [Fact]
    public void Match_5Tuple_Success_CreatesActivityWithOkStatus()
    {
        // Arrange
        using var activityTest = new ActivityTestHelper();
        var result = Result.Success((1, 2, 3, 4, 5));

        // Act
        var sum = result.Match(
            onSuccess: (a, b, c, d, e) => a + b + c + d + e,
            onFailure: _ => 0
        );

        // Assert
        sum.Should().Be(15);
        activityTest.AssertActivityCapturedWithStatus("Match", ActivityStatusCode.Ok);
    }

    [Fact]
    public void Switch_3Tuple_Success_CreatesActivityWithOkStatus()
    {
        // Arrange
        using var activityTest = new ActivityTestHelper();
        var result = Result.Success((1, "two", 3.0));
        var output = "";

        // Act
        result.Switch(
            onSuccess: (i, s, d) => output = $"{i}-{s}-{d}",
            onFailure: _ => { }
        );

        // Assert
        output.Should().Be("1-two-3");
        activityTest.AssertActivityCapturedWithStatus("Switch", ActivityStatusCode.Ok);
    }

    #endregion

    #region Async Match Tracing Tests

    [Fact]
    public async Task MatchAsync_2Tuple_SyncHandlers_Success_CreatesActivityWithOkStatus()
    {
        // Arrange
        using var activityTest = new ActivityTestHelper();
        var resultTask = Task.FromResult(Result.Success((42, "hello")));

        // Act
        var output = await resultTask.MatchAsync(
            onSuccess: (num, str) => $"{num}-{str}",
            onFailure: _ => "Error"
        );

        // Assert
        output.Should().Be("42-hello");

        // Wait for async activity capture
        await Task.Delay(50, TestContext.Current.CancellationToken);
        activityTest.ActivityCount.Should().BeGreaterThan(0);
    }

    [Fact]
    public async Task MatchAsync_2Tuple_AsyncHandlers_Success_CreatesActivityWithOkStatus()
    {
        // Arrange
        using var activityTest = new ActivityTestHelper();
        var result = Result.Success((42, "hello"));

        // Act
        var output = await result.MatchAsync(
            onSuccess: async (num, str) =>
            {
                await Task.Delay(10);
                return $"{num}-{str}";
            },
            onFailure: async _ =>
            {
                await Task.Delay(10);
                return "Error";
            }
        );

        // Assert
        output.Should().Be("42-hello");

        // Wait for async activity capture
        await Task.Delay(50, TestContext.Current.CancellationToken);
        activityTest.ActivityCount.Should().BeGreaterThan(0);
    }

    [Fact]
    public async Task MatchAsync_2Tuple_AsyncHandlers_Failure_CreatesActivity()
    {
        // Arrange
        using var activityTest = new ActivityTestHelper();
        var result = Result.Failure<(int, string)>(Error.NotFound("Not found"));

        // Act
        var output = await result.MatchAsync(
            onSuccess: async (num, str) =>
            {
                await Task.Delay(10);
                return "Success";
            },
            onFailure: async err =>
            {
                await Task.Delay(10);
                return err.Detail;
            }
        );

        // Assert
        output.Should().Be("Not found");

        // Wait for async activity capture
        await Task.Delay(50, TestContext.Current.CancellationToken);
        activityTest.ActivityCount.Should().BeGreaterThan(0);
    }

    #endregion

    #region Async Switch Tracing Tests

    [Fact]
    public async Task SwitchAsync_2Tuple_Success_CreatesActivity()
    {
        // Arrange
        using var activityTest = new ActivityTestHelper();
        var resultTask = Task.FromResult(Result.Success((42, "hello")));
        var executed = false;

        // Act
        await resultTask.SwitchAsync(
            onSuccess: async (num, str) =>
            {
                await Task.Delay(10);
                executed = true;
            },
            onFailure: async _ => await Task.CompletedTask
        );

        // Assert
        executed.Should().BeTrue();

        // Wait for async activity capture
        await Task.Delay(50, TestContext.Current.CancellationToken);
        activityTest.ActivityCount.Should().BeGreaterThan(0);
    }

    [Fact]
    public async Task SwitchAsync_2Tuple_Failure_CreatesActivity()
    {
        // Arrange
        using var activityTest = new ActivityTestHelper();
        var resultTask = Task.FromResult(Result.Failure<(int, string)>(Error.Unexpected("Error")));
        var errorLogged = false;

        // Act
        await resultTask.SwitchAsync(
            onSuccess: async (num, str) => await Task.CompletedTask,
            onFailure: async err =>
            {
                await Task.Delay(10);
                errorLogged = true;
            }
        );

        // Assert
        errorLogged.Should().BeTrue();

        // Wait for async activity capture
        await Task.Delay(50, TestContext.Current.CancellationToken);
        activityTest.ActivityCount.Should().BeGreaterThan(0);
    }

    #endregion

    #region Real-World Scenarios with Tracing

    [Fact]
    public void Match_CombinedResults_ToDto_TracesOkStatus()
    {
        // Arrange
        using var activityTest = new ActivityTestHelper();
        var combined = Result.Success(("user@example.com", "John Doe"));

        // Act
        var dto = combined.Match(
            onSuccess: (email, name) => new { Email = email, Name = name },
            onFailure: _ => new { Email = "", Name = "" }
        );

        // Assert
        dto.Email.Should().Be("user@example.com");
        activityTest.AssertActivityCapturedWithStatus("Match", ActivityStatusCode.Ok);
    }

    [Fact]
    public void Match_CombinedResults_Failure_TracesErrorStatus()
    {
        // Arrange
        using var activityTest = new ActivityTestHelper();
        var combined = Result.Failure<(string, string)>(Error.Validation("Bad input", "field"));

        // Act
        var response = combined.Match(
            onSuccess: (email, name) => new { Success = true },
            onFailure: err => new { Success = false }
        );

        // Assert
        response.Success.Should().BeFalse();
        activityTest.AssertActivityCapturedWithStatus("Match", ActivityStatusCode.Error);
    }

    [Fact]
    public void Match_AfterCombinePipeline_TracesAllOperations()
    {
        // Arrange
        using var activityTest = new ActivityTestHelper();

        // Act
        var result = Result.Success("First")
            .Combine(Result.Success("Second"))
            .Match(
                onSuccess: (a, b) => $"{a} {b}",
                onFailure: err => "Error"
            );

        // Assert
        result.Should().Be("First Second");

        // Should have 1 Combine + 1 Match activity
        activityTest.AssertActivityCaptured(2);
        activityTest.AssertActivityCapturedWithStatus("Match", ActivityStatusCode.Ok);
    }

    [Fact]
    public void Switch_WithLogging_TracesOkStatus()
    {
        // Arrange
        using var activityTest = new ActivityTestHelper();
        var result = Result.Success((100, 200));
        var logged = new List<int>();

        // Act
        result.Switch(
            onSuccess: (a, b) =>
            {
                logged.Add(a);
                logged.Add(b);
            },
            onFailure: _ => { }
        );

        // Assert
        logged.Should().ContainInOrder(100, 200);
        activityTest.AssertActivityCapturedWithStatus("Switch", ActivityStatusCode.Ok);
    }

    #endregion

    #region Activity Name Verification

    [Fact]
    public void Match_CreatesActivity_WithCorrectName()
    {
        // Arrange
        using var activityTest = new ActivityTestHelper();
        var result = Result.Success((42, "hello"));

        // Act
        result.Match(
            onSuccess: (num, str) => "output",
            onFailure: _ => "error"
        );

        // Assert
        var activity = activityTest.AssertActivityCaptured("Match");
        activity.DisplayName.Should().Be("Match");
    }

    [Fact]
    public void Switch_CreatesActivity_WithCorrectName()
    {
        // Arrange
        using var activityTest = new ActivityTestHelper();
        var result = Result.Success((42, "hello"));

        // Act
        result.Switch(
            onSuccess: (num, str) => { },
            onFailure: _ => { }
        );

        // Assert
        var activity = activityTest.AssertActivityCaptured("Switch");
        activity.DisplayName.Should().Be("Switch");
    }

    #endregion
}
namespace RailwayOrientedProgramming.Tests.Results.Extensions;

using FunctionalDdd.Testing;

/// <summary>
/// Functional tests for TapOnFailure operations on tuple results generated by TapOnFailureTs.g.tt.
/// Tests side effect execution on failure paths for combined results without modifying the result.
/// 
/// Since all tuple sizes (2-9) are generated from the same T4 template, we test the 2-tuple
/// permutation comprehensively and validate other sizes work correctly.
/// </summary>
public class TapOnFailureTupleTests : TestBase
{
    private bool _actionExecuted;
    private Error? _capturedError;
    private int _executionCount;

    public TapOnFailureTupleTests()
    {
        _actionExecuted = false;
        _capturedError = null;
        _executionCount = 0;
    }

    #region 2-Tuple TapOnFailure Tests (Comprehensive Coverage)

    [Fact]
    public void TapOnFailure_2Tuple_WithAction_Failure_ExecutesAction()
    {
        // Arrange
        var result = Result.Failure<(int, string)>(Error.Validation("Validation failed"));

        // Act
        var actual = result.TapOnFailure(() => _actionExecuted = true);

        // Assert
        _actionExecuted.Should().BeTrue();
        actual.Should().BeFailure();
        actual.Error.Should().BeOfType<ValidationError>();
    }

    [Fact]
    public void TapOnFailure_2Tuple_WithAction_Success_DoesNotExecute()
    {
        // Arrange
        var result = Result.Success((42, "hello"));

        // Act
        var actual = result.TapOnFailure(() => _actionExecuted = true);

        // Assert
        _actionExecuted.Should().BeFalse();
        actual.Should().BeSuccess();
        actual.Value.Should().Be((42, "hello"));
    }

    [Fact]
    public void TapOnFailure_2Tuple_WithActionError_Failure_PassesError()
    {
        // Arrange
        var result = Result.Failure<(int, string)>(Error.NotFound("Item not found", "item-123"));

        // Act
        var actual = result.TapOnFailure(error =>
        {
            _actionExecuted = true;
            _capturedError = error;
        });

        // Assert
        _actionExecuted.Should().BeTrue();
        Assert.NotNull(_capturedError);
        _capturedError.Should().BeOfType<NotFoundError>();
        _capturedError.Detail.Should().Be("Item not found");
        _capturedError.Instance.Should().Be("item-123");
        actual.Should().BeFailure();
    }

    [Fact]
    public void TapOnFailure_2Tuple_WithActionError_Success_DoesNotExecute()
    {
        // Arrange
        var result = Result.Success((42, "hello"));

        // Act
        var actual = result.TapOnFailure(error =>
        {
            _actionExecuted = true;
            _capturedError = error;
        });

        // Assert
        _actionExecuted.Should().BeFalse();
        Assert.Null(_capturedError);
        actual.Should().BeSuccess();
    }

    [Fact]
    public void TapOnFailure_2Tuple_ChainedActions_ExecutesAll()
    {
        // Arrange
        var result = Result.Failure<(int, string)>(Error.Unexpected("Something went wrong"));

        // Act
        var actual = result
            .TapOnFailure(() => _executionCount++)
            .TapOnFailure(() => _executionCount++)
            .TapOnFailure(() => _executionCount++);

        // Assert
        _executionCount.Should().Be(3);
        actual.Should().BeFailure();
    }

    [Fact]
    public void TapOnFailure_2Tuple_PreservesOriginalResult()
    {
        // Arrange
        var originalError = Error.Forbidden("Access denied");
        var result = Result.Failure<(int, string)>(originalError);

        // Act
        var actual = result.TapOnFailure(error => _actionExecuted = true);

        // Assert
        actual.Should().BeFailure();
        actual.Error.Should().BeSameAs(originalError);
    }

    [Fact]
    public void TapOnFailure_2Tuple_DifferentTypes_Failure_ExecutesAction()
    {
        // Arrange
        var result = Result.Failure<(string, bool)>(Error.Validation("Invalid data"));

        // Act
        var actual = result.TapOnFailure(() => _actionExecuted = true);

        // Assert
        _actionExecuted.Should().BeTrue();
        actual.Should().BeFailure();
    }

    #endregion

    #region 2-Tuple Async Tests

    [Fact]
    public async Task TapOnFailureAsync_2Tuple_TaskResult_WithAction_Failure_ExecutesAction()
    {
        // Arrange
        var result = Task.FromResult(Result.Failure<(int, string)>(Error.Validation("Failed")));

        // Act
        var actual = await result.TapOnFailureAsync(() => _actionExecuted = true);

        // Assert
        _actionExecuted.Should().BeTrue();
        actual.Should().BeFailure();
    }

    [Fact]
    public async Task TapOnFailureAsync_2Tuple_TaskResult_WithAction_Success_DoesNotExecute()
    {
        // Arrange
        var result = Task.FromResult(Result.Success((42, "hello")));

        // Act
        var actual = await result.TapOnFailureAsync(() => _actionExecuted = true);

        // Assert
        _actionExecuted.Should().BeFalse();
        actual.Should().BeSuccess();
    }

    [Fact]
    public async Task TapOnFailureAsync_2Tuple_TaskResult_WithActionError_PassesError()
    {
        // Arrange
        var result = Task.FromResult(Result.Failure<(int, string)>(Error.Conflict("Conflict")));

        // Act
        var actual = await result.TapOnFailureAsync(error =>
        {
            _actionExecuted = true;
            _capturedError = error;
        });

        // Assert
        _actionExecuted.Should().BeTrue();
        Assert.NotNull(_capturedError);
        _capturedError.Should().BeOfType<ConflictError>();
        actual.Should().BeFailure();
    }

    [Fact]
    public async Task TapOnFailureAsync_2Tuple_WithFuncTask_Failure_ExecutesFunction()
    {
        // Arrange
        var result = Result.Failure<(int, string)>(Error.Unexpected("Error"));

        // Act
        var actual = await result.TapOnFailureAsync(() =>
        {
            _actionExecuted = true;
            return Task.CompletedTask;
        });

        // Assert
        _actionExecuted.Should().BeTrue();
        actual.Should().BeFailure();
    }

    [Fact]
    public async Task TapOnFailureAsync_2Tuple_WithFuncTask_Success_DoesNotExecute()
    {
        // Arrange
        var result = Result.Success((42, "hello"));

        // Act
        var actual = await result.TapOnFailureAsync(() =>
        {
            _actionExecuted = true;
            return Task.CompletedTask;
        });

        // Assert
        _actionExecuted.Should().BeFalse();
        actual.Should().BeSuccess();
    }

    [Fact]
    public async Task TapOnFailureAsync_2Tuple_WithFuncErrorTask_PassesError()
    {
        // Arrange
        var result = Result.Failure<(int, string)>(Error.BadRequest("Bad request"));

        // Act
        var actual = await result.TapOnFailureAsync(error =>
        {
            _actionExecuted = true;
            _capturedError = error;
            return Task.CompletedTask;
        });

        // Assert
        _actionExecuted.Should().BeTrue();
        Assert.NotNull(_capturedError);
        _capturedError.Should().BeOfType<BadRequestError>();
        actual.Should().BeFailure();
    }

    [Fact]
    public async Task TapOnFailureAsync_2Tuple_TaskResult_WithFuncTask_Failure()
    {
        // Arrange
        var result = Task.FromResult(Result.Failure<(int, string)>(Error.ServiceUnavailable("Down")));

        // Act
        var actual = await result.TapOnFailureAsync(() =>
        {
            _actionExecuted = true;
            return Task.CompletedTask;
        });

        // Assert
        _actionExecuted.Should().BeTrue();
        actual.Should().BeFailure();
    }

    [Fact]
    public async Task TapOnFailureAsync_2Tuple_TaskResult_WithFuncErrorTask_PassesError()
    {
        // Arrange
        var result = Task.FromResult(Result.Failure<(int, string)>(Error.Forbidden("Forbidden")));

        // Act
        var actual = await result.TapOnFailureAsync(error =>
        {
            _capturedError = error;
            return Task.CompletedTask;
        });

        // Assert
        Assert.NotNull(_capturedError);
        _capturedError.Should().BeOfType<ForbiddenError>();
        actual.Should().BeFailure();
    }

    [Fact]
    public async Task TapOnFailureAsync_2Tuple_ValueTask_WithAction_Failure()
    {
        // Arrange
        var result = ValueTask.FromResult(Result.Failure<(int, string)>(Error.RateLimit("Too many")));

        // Act
        var actual = await result.TapOnFailureAsync(() => _actionExecuted = true);

        // Assert
        _actionExecuted.Should().BeTrue();
        actual.Should().BeFailure();
    }

    [Fact]
    public async Task TapOnFailureAsync_2Tuple_ValueTask_WithActionError_PassesError()
    {
        // Arrange
        var result = ValueTask.FromResult(Result.Failure<(int, string)>(Error.Unauthorized("Unauthorized")));

        // Act
        var actual = await result.TapOnFailureAsync(error => _capturedError = error);

        // Assert
        Assert.NotNull(_capturedError);
        _capturedError.Should().BeOfType<UnauthorizedError>();
        actual.Should().BeFailure();
    }

    [Fact]
    public async Task TapOnFailureAsync_2Tuple_WithFuncValueTask_Failure()
    {
        // Arrange
        var result = Result.Failure<(int, string)>(Error.Conflict("Conflict"));

        // Act
        var actual = await result.TapOnFailureAsync(() =>
        {
            _actionExecuted = true;
            return ValueTask.CompletedTask;
        });

        // Assert
        _actionExecuted.Should().BeTrue();
        actual.Should().BeFailure();
    }

    [Fact]
    public async Task TapOnFailureAsync_2Tuple_WithFuncErrorValueTask_PassesError()
    {
        // Arrange
        var result = Result.Failure<(int, string)>(Error.NotFound("Not found"));

        // Act
        var actual = await result.TapOnFailureAsync(error =>
        {
            _capturedError = error;
            return ValueTask.CompletedTask;
        });

        // Assert
        Assert.NotNull(_capturedError);
        _capturedError.Should().BeOfType<NotFoundError>();
        actual.Should().BeFailure();
    }

    #endregion

    #region Other Tuple Sizes (Validation Tests)

    [Fact]
    public void TapOnFailure_3Tuple_Failure_ExecutesAction()
    {
        // Arrange
        var result = Result.Failure<(int, string, bool)>(Error.Validation("Failed"));

        // Act
        var actual = result.TapOnFailure(() => _actionExecuted = true);

        // Assert
        _actionExecuted.Should().BeTrue();
        actual.Should().BeFailure();
    }

    [Fact]
    public void TapOnFailure_4Tuple_Failure_ExecutesAction()
    {
        // Arrange
        var result = Result.Failure<(int, int, int, int)>(Error.Unexpected("Error"));

        // Act
        var actual = result.TapOnFailure(() => _actionExecuted = true);

        // Assert
        _actionExecuted.Should().BeTrue();
        actual.Should().BeFailure();
    }

    [Fact]
    public void TapOnFailure_5Tuple_Failure_ExecutesAction()
    {
        // Arrange
        var result = Result.Failure<(int, int, int, int, int)>(Error.NotFound("Not found"));

        // Act
        var actual = result.TapOnFailure(() => _actionExecuted = true);

        // Assert
        _actionExecuted.Should().BeTrue();
        actual.Should().BeFailure();
    }

    [Fact]
    public void TapOnFailure_6Tuple_Failure_ExecutesAction()
    {
        // Arrange
        var result = Result.Failure<(int, int, int, int, int, int)>(Error.Forbidden("Forbidden"));

        // Act
        var actual = result.TapOnFailure(() => _actionExecuted = true);

        // Assert
        _actionExecuted.Should().BeTrue();
        actual.Should().BeFailure();
    }

    [Fact]
    public void TapOnFailure_7Tuple_Failure_ExecutesAction()
    {
        // Arrange
        var result = Result.Failure<(int, int, int, int, int, int, int)>(Error.Conflict("Conflict"));

        // Act
        var actual = result.TapOnFailure(() => _actionExecuted = true);

        // Assert
        _actionExecuted.Should().BeTrue();
        actual.Should().BeFailure();
    }

    [Fact]
    public void TapOnFailure_8Tuple_Failure_ExecutesAction()
    {
        // Arrange
        var result = Result.Failure<(int, int, int, int, int, int, int, int)>(Error.BadRequest("Bad"));

        // Act
        var actual = result.TapOnFailure(() => _actionExecuted = true);

        // Assert
        _actionExecuted.Should().BeTrue();
        actual.Should().BeFailure();
    }

    [Fact]
    public void TapOnFailure_9Tuple_Failure_ExecutesAction()
    {
        // Arrange
        var result = Result.Failure<(int, int, int, int, int, int, int, int, int)>(Error.Validation("Invalid"));

        // Act
        var actual = result.TapOnFailure(() => _actionExecuted = true);

        // Assert
        _actionExecuted.Should().BeTrue();
        actual.Should().BeFailure();
    }

    #endregion

    #region Real-World Scenarios

    [Fact]
    public void TapOnFailure_AfterCombine_LogsValidationErrors()
    {
        // Arrange
        var loggedMessages = new List<string>();

        // Act
        var result = Result.Failure<string>(Error.Validation("Invalid email", "email"))
            .Combine(Result.Failure<string>(Error.Validation("Invalid phone", "phone")))
            .TapOnFailure(error =>
            {
                if (error is ValidationError validationError)
                {
                    foreach (var fieldError in validationError.FieldErrors)
                    {
                        loggedMessages.Add($"{fieldError.FieldName}: {string.Join(", ", fieldError.Details)}");
                    }
                }
            });

        // Assert
        loggedMessages.Should().HaveCount(2);
        loggedMessages[0].Should().Contain("email");
        loggedMessages[1].Should().Contain("phone");
        result.Should().BeFailure();
    }

    [Fact]
    public async Task TapOnFailureAsync_SendErrorNotification_OnCombinedFailure()
    {
        // Arrange
        var notificationsSent = new List<string>();

        // Act
        var result = await Task.FromResult(
            Result.Failure<string>(Error.NotFound("User not found"))
                .Combine(Result.Success("data")))
            .TapOnFailureAsync(async error =>
            {
                await Task.Delay(10);
                notificationsSent.Add($"Error notification: {error.Code}");
            });

        // Assert
        notificationsSent.Should().ContainSingle();
        notificationsSent[0].Should().Contain("not.found");
        result.Should().BeFailure();
    }

    [Fact]
    public void TapOnFailure_IncrementErrorMetrics_DifferentErrorTypes()
    {
        // Arrange
        var errorCounts = new Dictionary<string, int>();

        // Act - Test different error types
        Result.Failure<(int, string)>(Error.Validation("Invalid"))
            .TapOnFailure(error => errorCounts[error.Code] = errorCounts.GetValueOrDefault(error.Code) + 1);

        Result.Failure<(int, string)>(Error.NotFound("Not found"))
            .TapOnFailure(error => errorCounts[error.Code] = errorCounts.GetValueOrDefault(error.Code) + 1);

        Result.Failure<(int, string)>(Error.Validation("Another invalid"))
            .TapOnFailure(error => errorCounts[error.Code] = errorCounts.GetValueOrDefault(error.Code) + 1);

        // Assert
        errorCounts.Should().ContainKey("validation.error");
        errorCounts["validation.error"].Should().Be(2);
        errorCounts.Should().ContainKey("not.found.error");
        errorCounts["not.found.error"].Should().Be(1);
    }

    [Fact]
    public void TapOnFailure_ChainedWithBind_ExecutesBeforeBind()
    {
        // Arrange
        var executionOrder = new List<string>();
        var bindCalled = false;

        // Act
        var result = Result.Failure<string>(Error.Unexpected("Error"))
            .Combine(Result.Success("data"))
            .TapOnFailure(error => executionOrder.Add("TapOnFailure"))
            .Bind((a, b) =>
            {
                bindCalled = true;
                executionOrder.Add("Bind");
                return Result.Success("processed");
            });

        // Assert
        executionOrder.Should().ContainSingle();
        executionOrder[0].Should().Be("TapOnFailure");
        bindCalled.Should().BeFalse(); // Bind should be short-circuited
        result.Should().BeFailure();
    }

    [Fact]
    public async Task TapOnFailureAsync_CleanupResourcesOnFailure()
    {
        // Arrange
        var resourcesCleaned = false;

        // Act
        var result = await Result.Failure<string>(Error.ServiceUnavailable("DB down"))
            .Combine(Result.Success("transaction"))
            .TapOnFailureAsync((Error error) =>
            {
                if (error is ServiceUnavailableError)
                {
                    resourcesCleaned = true;
                }

                return Task.CompletedTask;
            });

        // Assert
        resourcesCleaned.Should().BeTrue();
        result.Should().BeFailure();
    }

    #endregion
}
namespace RailwayOrientedProgramming.Tests.Results;

using FunctionalDdd.Testing;
using RailwayOrientedProgramming.Tests.Helpers;
using System.Diagnostics;

/// <summary>
/// Tests for Activity tracing in tuple-based Result operations (generated by T4 templates).
/// Verifies that operations on Result&lt;(T1, T2, ...)&gt; create proper OpenTelemetry activities.
/// Since all tuple sizes are generated from the same template pattern, we test 2-tuple and 3-tuple permutations.
/// </summary>
public class TupleTracingTests : TestBase
{
    #region 2-Tuple Bind Tracing Tests

    [Fact]
    public void Bind_2Tuple_Success_CreatesActivityWithOkStatus()
    {
        // Arrange
        using var activityTest = new ActivityTestHelper();

        // Act
        var result = Result.Success((T.Value1, K.Value1))
            .Bind((t, k) => Result.Success($"{t}-{k}"));

        // Assert
        result.Should().BeSuccess();
        activityTest.AssertActivityCapturedWithStatus("Bind", ActivityStatusCode.Ok);
    }

    [Fact]
    public void Bind_2Tuple_Failure_CreatesActivityWithErrorStatus()
    {
        // Arrange
        using var activityTest = new ActivityTestHelper();

        // Act
        var result = Result.Failure<(T, K)>(Error1)
            .Bind((t, k) => Result.Success($"{t}-{k}"));

        // Assert
        result.Should().BeFailure();
        activityTest.AssertActivityCapturedWithStatus("Bind", ActivityStatusCode.Error);
    }

    [Fact]
    public async Task BindAsync_2Tuple_Task_Success_CreatesActivityWithOkStatus()
    {
        // Arrange
        using var activityTest = new ActivityTestHelper();

        // Act
        var result = await Result.Success((T.Value1, K.Value1))
            .BindAsync((t, k) => Task.FromResult(Result.Success($"{t}-{k}")));

        // Assert
        result.Should().BeSuccess();
        activityTest.AssertActivityCapturedWithStatus("Bind", ActivityStatusCode.Ok);
    }

    [Fact]
    public async Task BindAsync_2Tuple_TaskResult_Failure_CreatesActivityWithErrorStatus()
    {
        // Arrange
        using var activityTest = new ActivityTestHelper();

        // Act
        var result = await Result.Failure<(T, K)>(Error1).AsTask()
            .BindAsync((t, k) => Result.Success($"{t}-{k}"));

        // Assert
        result.Should().BeFailure();
        activityTest.AssertActivityCapturedWithStatus("Bind", ActivityStatusCode.Error);
    }

    [Fact]
    public async Task BindAsync_2Tuple_ValueTask_Success_CreatesActivityWithOkStatus()
    {
        // Arrange
        using var activityTest = new ActivityTestHelper();

        // Act
        var result = await Result.Success((T.Value1, K.Value1))
            .BindAsync((t, k) => ValueTask.FromResult(Result.Success($"{t}-{k}")));

        // Assert
        result.Should().BeSuccess();
        activityTest.AssertActivityCapturedWithStatus("Bind", ActivityStatusCode.Ok);
    }

    #endregion

    #region 3-Tuple Bind Tracing Tests

    [Fact]
    public void Bind_3Tuple_Success_CreatesActivityWithOkStatus()
    {
        // Arrange
        using var activityTest = new ActivityTestHelper();

        // Act
        var result = Result.Success((T.Value1, K.Value1, 42))
            .Bind((t, k, num) => Result.Success($"{t}-{k}-{num}"));

        // Assert
        result.Should().BeSuccess();
        activityTest.AssertActivityCapturedWithStatus("Bind", ActivityStatusCode.Ok);
    }

    [Fact]
    public async Task BindAsync_3Tuple_BothAsync_Success_CreatesActivityWithOkStatus()
    {
        // Arrange
        using var activityTest = new ActivityTestHelper();

        // Act
        var result = await Result.Success((T.Value1, K.Value1, 42)).AsTask()
            .BindAsync((t, k, num) => Task.FromResult(Result.Success($"{t}-{k}-{num}")));

        // Assert
        result.Should().BeSuccess();
        activityTest.AssertActivityCapturedWithStatus("Bind", ActivityStatusCode.Ok);
    }

    #endregion

    #region 2-Tuple TapOnFailure Tracing Tests

    [Fact]
    public void TapOnFailure_2Tuple_Success_CreatesActivityWithOkStatus()
    {
        // Arrange
        using var activityTest = new ActivityTestHelper();
        var actionCalled = false;

        // Act
        var result = Result.Success((T.Value1, K.Value1))
            .TapOnFailure(() => actionCalled = true);

        // Assert
        result.Should().BeSuccess();
        actionCalled.Should().BeFalse();

        // TapOnFailure creates an activity and logs the result status (Ok for success)
        var activities = activityTest.CapturedActivities;
        var tapActivity = activities.FirstOrDefault(a => a.DisplayName == "TapOnFailure");
        tapActivity.Should().NotBeNull();
        tapActivity!.Status.Should().Be(ActivityStatusCode.Ok); // Success result gets Ok status
    }

    [Fact]
    public void TapOnFailure_2Tuple_Failure_CreatesActivityWithErrorStatus()
    {
        // Arrange
        using var activityTest = new ActivityTestHelper();
        var actionCalled = false;

        // Act
        var result = Result.Failure<(T, K)>(Error1)
            .TapOnFailure(() => actionCalled = true);

        // Assert
        result.Should().BeFailure();
        actionCalled.Should().BeTrue();
        activityTest.AssertActivityCapturedWithStatus("TapOnFailure", ActivityStatusCode.Error);
    }

    [Fact]
    public void TapOnFailure_2Tuple_WithErrorAction_Failure_CreatesActivityWithErrorStatus()
    {
        // Arrange
        using var activityTest = new ActivityTestHelper();
        Error? capturedError = null;

        // Act
        var result = Result.Failure<(T, K)>(Error1)
            .TapOnFailure(error => capturedError = error);

        // Assert
        result.Should().BeFailure();
        Assert.NotNull(capturedError);
        capturedError.Should().Be(Error1);
        activityTest.AssertActivityCapturedWithStatus("TapOnFailure", ActivityStatusCode.Error);
    }

    [Fact]
    public async Task TapOnFailureAsync_2Tuple_TaskResult_Failure_CreatesActivityWithErrorStatus()
    {
        // Arrange
        using var activityTest = new ActivityTestHelper();
        var actionCalled = false;

        // Act
        var result = await Result.Failure<(T, K)>(Error1).AsTask()
            .TapOnFailureAsync(() => actionCalled = true);

        // Assert
        result.Should().BeFailure();
        actionCalled.Should().BeTrue();
        activityTest.AssertActivityCapturedWithStatus("TapOnFailure", ActivityStatusCode.Error);
    }

    [Fact]
    public async Task TapOnFailureAsync_2Tuple_WithAsyncFunc_Failure_CreatesActivityWithErrorStatus()
    {
        // Arrange
        using var activityTest = new ActivityTestHelper();
        var actionCalled = false;

        // Act
        var result = await Result.Failure<(T, K)>(Error1)
            .TapOnFailureAsync(() =>
            {
                actionCalled = true;
                return Task.CompletedTask;
            });

        // Assert
        result.Should().BeFailure();
        actionCalled.Should().BeTrue();
        activityTest.AssertActivityCapturedWithStatus("TapOnFailure", ActivityStatusCode.Error);
    }

    [Fact]
    public async Task TapOnFailureAsync_2Tuple_ValueTask_Failure_CreatesActivityWithErrorStatus()
    {
        // Arrange
        using var activityTest = new ActivityTestHelper();
        var actionCalled = false;

        // Act
        var result = await Result.Failure<(T, K)>(Error1).AsValueTask()
            .TapOnFailureAsync(() => actionCalled = true);

        // Assert
        result.Should().BeFailure();
        actionCalled.Should().BeTrue();
        activityTest.AssertActivityCapturedWithStatus("TapOnFailure", ActivityStatusCode.Error);
    }

    #endregion

    #region 3-Tuple TapOnFailure Tracing Tests

    [Fact]
    public void TapOnFailure_3Tuple_Failure_CreatesActivityWithErrorStatus()
    {
        // Arrange
        using var activityTest = new ActivityTestHelper();
        var actionCalled = false;

        // Act
        var result = Result.Failure<(T, K, int)>(Error1)
            .TapOnFailure(() => actionCalled = true);

        // Assert
        result.Should().BeFailure();
        actionCalled.Should().BeTrue();
        activityTest.AssertActivityCapturedWithStatus("TapOnFailure", ActivityStatusCode.Error);
    }

    #endregion

    #region Complex Tuple Pipeline Tracing

    [Fact]
    public void TuplePipeline_Combine_Bind_TapOnFailure_TracesAllOperations()
    {
        // Arrange
        using var activityTest = new ActivityTestHelper();

        // Act - Real-world scenario: Combine multiple validations then bind
        var result = Result.Success("John")
            .Combine(Result.Success("Doe"))
            .Bind((first, last) => Result.Success($"{first} {last}"))
            .TapOnFailure(error => Console.WriteLine($"Error: {error.Detail}"));

        // Assert
        result.Should().BeSuccess()
            .Which.Should().Be("John Doe");

        // Verify tracing
        activityTest.AssertActivityCapturedWithStatus("Combine", ActivityStatusCode.Ok);
        activityTest.AssertActivityCapturedWithStatus("Bind", ActivityStatusCode.Ok);
    }

    [Fact]
    public void TuplePipeline_CombineFailure_Bind_TapOnFailure_TracesFailurePath()
    {
        // Arrange
        using var activityTest = new ActivityTestHelper();
        var errorLogged = false;

        // Act - One validation fails in Combine
        var result = Result.Failure<string>(Error.Validation("First name required"))
            .Combine(Result.Success("Doe"))
            .Bind((first, last) => Result.Success($"{first} {last}"))
            .TapOnFailure(error => errorLogged = true);

        // Assert
        result.Should().BeFailureOfType<ValidationError>();
        errorLogged.Should().BeTrue();

        // Verify failure path tracing
        activityTest.AssertActivityCapturedWithStatus("Combine", ActivityStatusCode.Error);
        activityTest.AssertActivityCapturedWithStatus("Bind", ActivityStatusCode.Error); // Short-circuited
        activityTest.AssertActivityCapturedWithStatus("TapOnFailure", ActivityStatusCode.Error);
    }

    [Fact]
    public async Task TuplePipeline_AsyncCombine_BindAsync_TapOnFailureAsync_MaintainsTraceContext()
    {
        // Arrange
        using var activityTest = new ActivityTestHelper();

        // Act - Async pipeline with tuples
        var result = await Result.Success("user@example.com")
            .Combine(Result.Success("password123"))
            .BindAsync((email, password) =>
                Task.FromResult(Result.Success($"Authenticated: {email}"))
            )
            .TapOnFailureAsync(error =>
            {
                Console.WriteLine($"Auth failed: {error.Detail}");
                return Task.CompletedTask;
            });

        // Assert
        result.Should().BeSuccess();

        // Verify activities were captured across async boundaries
        activityTest.AssertActivityCapturedWithStatus("Combine", ActivityStatusCode.Ok);
        activityTest.AssertActivityCapturedWithStatus("Bind", ActivityStatusCode.Ok);
    }

    [Fact]
    public void TuplePipeline_MultipleBinds_TracksEachOperation()
    {
        // Arrange
        using var activityTest = new ActivityTestHelper();

        // Act - Chain multiple Binds on tuple results
        var result = Result.Success(("John", "Doe"))
            .Bind((first, last) => Result.Success($"{first} {last}"))
            .Bind(fullName => Result.Success(fullName.ToUpperInvariant()))
            .Bind(upper => Result.Success(upper.Length));

        // Assert
        result.Should().BeSuccess()
            .Which.Should().Be(8); // "JOHN DOE".Length

        // Verify all Bind operations were traced
        var bindActivities = activityTest.AssertActivityCaptured("Bind", 3);
        bindActivities.Should().OnlyContain(a => a.Status == ActivityStatusCode.Ok);
    }

    [Fact]
    public void TuplePipeline_BindFails_SubsequentTapOnFailureExecutes()
    {
        // Arrange
        using var activityTest = new ActivityTestHelper();
        var tapExecuted = false;

        // Act - Bind fails, TapOnFailure should execute
        var result = Result.Success(("valid", "input"))
            .Bind((s1, s2) => Result.Failure<string>(Error.Unexpected("Bind failed")))
            .TapOnFailure(() => tapExecuted = true);

        // Assert
        result.Should().BeFailure();
        tapExecuted.Should().BeTrue();

        // Verify activities
        var activities = activityTest.CapturedActivities;
        var bindActivity = activities.First(a => a.DisplayName == "Bind");
        var tapActivity = activities.First(a => a.DisplayName == "TapOnFailure");

        bindActivity.Status.Should().Be(ActivityStatusCode.Error);
        tapActivity.Status.Should().Be(ActivityStatusCode.Error);
    }

    #endregion

    #region 3-Tuple Real-World Scenario

    [Fact]
    public async Task ThreeTuplePipeline_ComplexValidation_TracesAllOperations()
    {
        // Arrange
        using var activityTest = new ActivityTestHelper();

        // Act - Real-world: Validate email, firstName, lastName then create user
        var result = await Result.Success("user@example.com")
            .Combine(Result.Success("John"))
            .Combine(Result.Success("Doe"))
            .BindAsync((email, first, last) =>
                Task.FromResult(Result.Success($"{first} {last} <{email}>"))
            )
            .TapOnFailureAsync(async error =>
            {
                await Task.CompletedTask;
                Console.WriteLine($"User creation failed: {error.Detail}");
            });

        // Assert
        result.Should().BeSuccess()
            .Which.Should().Be("John Doe <user@example.com>");

        // Verify complete trace
        activityTest.AssertActivityCaptured("Combine", 2); // Two Combine operations
        activityTest.AssertActivityCapturedWithStatus("Bind", ActivityStatusCode.Ok);
    }

    [Fact]
    public void ThreeTuplePipeline_ValidationFails_TracesErrorPath()
    {
        // Arrange
        using var activityTest = new ActivityTestHelper();
        var errorMessage = string.Empty;

        // Act - Last validation fails
        var result = Result.Success("user@example.com")
            .Combine(Result.Success("John"))
            .Combine(Result.Failure<string>(Error.Validation("Last name required")))
            .Bind((email, first, last) => Result.Success($"{first} {last}"))
            .TapOnFailure(error => errorMessage = error.Detail);

        // Assert
        result.Should().BeFailureOfType<ValidationError>();
        errorMessage.Should().Contain("Last name required");

        // Verify error path tracing
        var activities = activityTest.CapturedActivities;
        var combineActivities = activities.Where(a => a.DisplayName == "Combine").ToList();

        // Last Combine should fail
        combineActivities.Last().Status.Should().Be(ActivityStatusCode.Error);

        // Bind and TapOnFailure should be on error track
        activityTest.AssertActivityCapturedWithStatus("Bind", ActivityStatusCode.Error);
        activityTest.AssertActivityCapturedWithStatus("TapOnFailure", ActivityStatusCode.Error);
    }

    #endregion
}
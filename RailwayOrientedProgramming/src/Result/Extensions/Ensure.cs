namespace FunctionalDdd;

using System;

/// <summary>
/// Provides extension methods for ensuring conditions on Result values.
/// If conditions fail, the result is converted to a failure with the specified error.
/// </summary>
/// <remarks>
/// Ensure methods allow you to validate result values against conditions and convert successful results
/// to failures if the validation fails. This is useful for enforcing business rules and constraints
/// in a functional pipeline without breaking the railway pattern.
/// </remarks>
public static class EnsureExtensions
{
    /// <summary>
    /// Returns a new failure result if the predicate is false. Otherwise returns the starting result.
    /// </summary>
    /// <typeparam name="TValue">Type of the result value.</typeparam>
    /// <param name="result">The result to validate.</param>
    /// <param name="predicate">The predicate to test.</param>
    /// <param name="errors">The error to return if the predicate is false.</param>
    /// <returns>The original result if success and predicate is true; otherwise a failure with the specified error.</returns>
    public static Result<TValue> Ensure<TValue>(this Result<TValue> result, Func<bool> predicate, Error errors)
    {
        using var activity = RopTrace.ActivitySource.StartActivity();
        if (result.IsFailure)
            return result;

        if (!predicate())
            return Result.Failure<TValue>(errors);

        return result;
    }

    /// <summary>
    /// Returns a new failure result if the predicate is false. Otherwise returns the starting result.
    /// </summary>
    /// <typeparam name="TValue">Type of the result value.</typeparam>
    /// <param name="result">The result to validate.</param>
    /// <param name="predicate">The predicate function to test the value.</param>
    /// <param name="error">The error to return if the predicate is false.</param>
    /// <returns>The original result if success and predicate is true; otherwise a failure with the specified error.</returns>
    public static Result<TValue> Ensure<TValue>(this Result<TValue> result, Func<TValue, bool> predicate, Error error)
    {
        using var activity = RopTrace.ActivitySource.StartActivity();
        if (result.IsFailure)
            return result;

        if (!predicate(result.Value))
            return Result.Failure<TValue>(error);

        return result;
    }

    /// <summary>
    /// Returns a new failure result if the predicate is false. Otherwise returns the starting result.
    /// The error is generated by a function that receives the value.
    /// </summary>
    /// <typeparam name="TValue">Type of the result value.</typeparam>
    /// <param name="result">The result to validate.</param>
    /// <param name="predicate">The predicate function to test the value.</param>
    /// <param name="errorPredicate">The function that generates an error from the value if the predicate is false.</param>
    /// <returns>The original result if success and predicate is true; otherwise a failure with an error from the error function.</returns>
    public static Result<TValue> Ensure<TValue>(this Result<TValue> result, Func<TValue, bool> predicate, Func<TValue, Error> errorPredicate)
    {
        using var activity = RopTrace.ActivitySource.StartActivity();
        if (result.IsFailure)
            return result;

        if (!predicate(result.Value))
            return Result.Failure<TValue>(errorPredicate(result.Value));

        return result;
    }

    /// <summary>
    /// Returns a new failure result if the predicate result is a failure. Otherwise returns the starting result.
    /// </summary>
    /// <typeparam name="TValue">Type of the result value.</typeparam>
    /// <param name="result">The result to validate.</param>
    /// <param name="predicate">The predicate function that returns a Result.</param>
    /// <returns>The original result if both it and the predicate result are successes; otherwise a failure.</returns>
    public static Result<TValue> Ensure<TValue>(this Result<TValue> result, Func<Result<TValue>> predicate)
    {
        using var activity = RopTrace.ActivitySource.StartActivity();
        if (result.IsFailure)
            return result;

        var predicateResult = predicate();

        if (predicateResult.IsFailure)
            return Result.Failure<TValue>(predicateResult.Error);

        return result;
    }

    /// <summary>
    /// Returns a new failure result if the predicate result is a failure. Otherwise returns the starting result.
    /// The predicate receives the value.
    /// </summary>
    /// <typeparam name="TValue">Type of the result value.</typeparam>
    /// <param name="result">The result to validate.</param>
    /// <param name="predicate">The predicate function that receives the value and returns a Result.</param>
    /// <returns>The original result if both it and the predicate result are successes; otherwise a failure.</returns>
    public static Result<TValue> Ensure<TValue>(this Result<TValue> result, Func<TValue, Result<TValue>> predicate)
    {
        using var activity = RopTrace.ActivitySource.StartActivity();
        if (result.IsFailure)
            return result;

        var predicateResult = predicate(result.Value);

        if (predicateResult.IsFailure)
            return Result.Failure<TValue>(predicateResult.Error);

        return result;
    }

    /// <summary>
    /// Ensures a string is not null or whitespace.
    /// </summary>
    /// <param name="str">The string to validate.</param>
    /// <param name="error">The error to return if the string is null or whitespace.</param>
    /// <returns>A success result with the string if valid; otherwise a failure with the specified error.</returns>
    public static Result<string> EnsureNotNullOrWhiteSpace(this string? str, Error error)
    {
        using var activity = RopTrace.ActivitySource.StartActivity();
        return string.IsNullOrWhiteSpace(str) ? Result.Failure<string>(error) : Result.Success(str);
    }

    /// <summary>
    /// Returns a success result if the flag is true; otherwise returns a failure with the specified error.
    /// </summary>
    /// <param name="flag">The boolean flag to test.</param>
    /// <param name="error">The error to return if the flag is false.</param>
    /// <returns>A success result if flag is true; otherwise a failure with the specified error.</returns>
    public static Result<Unit> Ensure(bool flag, Error error) => flag ? Result.Success() : Result.Failure(error);
}
